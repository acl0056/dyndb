<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>dyndb.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/DynDB.html">DynDB</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/dyndb.html">dyndb</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: dyndb.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
DynDB 0.1.0 - (c) 2012 Sergio Alcantara
Provides the base DynDB constructor

@module dyndb
@author Sergio Alcantara
 *&#x2F;

var http = require(&#x27;http&#x27;),
	https = require(&#x27;https&#x27;),
	_ = require(&#x27;underscore&#x27;),
	crypto = require(&#x27;crypto&#x27;);

&#x2F;**
DynDB Constructor.
It accepts the AWS access keys and the AWS region. If no arguments are passed,
it gets the keys and region from the following environment variables:

1. &#x60;AWS_ACCESS_KEY_ID&#x60;
2. &#x60;AWS_SECRET_ACCESS_KEY&#x60;
3. &#x60;AWS_REGION&#x60;

@class DynDB
@constructor
@param {String} [accessKeyID] Your AWS access key ID
@param {String} [secretAccessKey] Your AWS secret access key
@param {String} [region=&#x27;us-east-1&#x27;] The AWS region you would like to use
@param {String} [securityToken] The security token
 *&#x2F;
function DynDB() {
	&#x2F;**
	DynamoDB&#x27;s service name used in the HTTP headers and to create the signature that authenticates every request
	
	@property SERVICE_NAME
	@type String
	@final
	@private
	 *&#x2F;
	var SERVICE_NAME = &#x27;DynamoDB&#x27;;

	&#x2F;**
	DynamoDB&#x27;s API version used in the HTTP headers of every request

	@property API_VERSION
	@type String
	@final
	@private
	 *&#x2F;
	var API_VERSION = &#x27;20111205&#x27;;

	&#x2F;**
	IP address of the EC2 metadata service.

	@property EC2_METADATA_HOST
	@type String
	@final
	@private
	*&#x2F;
	var EC2_METADATA_HOST = &#x27;169.254.169.254&#x27;;

	&#x2F;**
	Path to the &#x60;security-credentials&#x60; within the EC2 metadata service.

	@property SECURITY_CREDENTIALS_RESOURCE
	@type String
	@final
	@private
	*&#x2F;
	var SECURITY_CREDENTIALS_RESOURCE = &#x27;&#x2F;latest&#x2F;meta-data&#x2F;iam&#x2F;security-credentials&#x2F;&#x27;;

	var CREDENTIALS_EXPIRATION_THRESHOLD = 1000 * 60 * 5; &#x2F;&#x2F; 5 minutes in milliseconds

	&#x2F;**
	AWS region.

	@property region
	@type String
	@private
	*&#x2F;
	var region = null;

	&#x2F;**
	AWS Access Key ID.

	@property accessKey
	@type String
	@private
	*&#x2F;
	var accessKey = null;

	&#x2F;**
	AWS Secret Access Key.

	@property secretKey
	@type String
	@private
	*&#x2F;
	var secretKey = null;

	&#x2F;**
	AWS Security Token, used only when the credentials come from the EC2 metadata service.

	@property securityToken
	@type String
	@private
	*&#x2F;
	var securityToken = null;

	&#x2F;**
	Expiration date of the current credentials obtained from the EC2 metadata service.

	@property credentialsExpiration
	@type Date
	@private
	*&#x2F;
	var credentialsExpiration = null;

	&#x2F;**
	Sets the access keys and region to use for every request. If no arguments are passed,
	it gets the keys and region from the following environment variables:

	1. &#x60;AWS_ACCESS_KEY_ID&#x60;
	2. &#x60;AWS_SECRET_ACCESS_KEY&#x60;
	3. &#x60;AWS_REGION&#x60;

	@method setup
	@chainable
	@param {String} [accessKeyID] Your AWS access key ID
	@param {String} [secretAccessKey] Your AWS secret access key
	@param {String} [region=&#x27;us-east-1&#x27;] The AWS region you would like to use
	@param {String} [securityToken] The security token
	 *&#x2F;
	(this.setup = function(accessKeyID, secretAccessKey, awsRegion, awsSecurityToken) {
		region = awsRegion || process.env.AWS_REGION || &#x27;us-east-1&#x27;;
		accessKey = accessKeyID || process.env.AWS_ACCESS_KEY_ID;
		secretKey = secretAccessKey || process.env.AWS_SECRET_ACCESS_KEY;
		securityToken = awsSecurityToken || null;

		return this;
	}).apply(this, arguments);

	&#x2F;**
	Uses [Crypto.Hmac](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;crypto.html#crypto_class_hmac) to calculate the SHA256 HMAC for the given data

	@method hmac
	@private
	@param {String} key The hmac key to be used
	@param {String} data The data for which to calculate the HMAC
	@param {String} [encoding=&#x27;binary&#x27;] The desired output encoding for the HMAC. Can be &#x60;&#x27;hex&#x27;&#x60;, &#x60;&#x27;binary&#x27;&#x60; or &#x60;&#x27;base64&#x27;&#x60;
	@returns {Object} The calculated HMAC value. The type of the return value depends on the given &#x60;encoding&#x60;
	 *&#x2F;
	function hmac(key, data, encoding) {
		var hmac = crypto.createHmac(&#x27;sha256&#x27;, key);
		hmac.update(data);
		return hmac.digest(encoding || &#x27;binary&#x27;);
	}

	&#x2F;**
	Uses [Crypto.Hash](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;crypto.html#crypto_class_hash) to calculate the SHA256 hash for the given data

	@method sha256Hash
	@private
	@param {String} data The data from which to calculate the hash
	@param {String} [dataEncoding=&#x27;binary&#x27;] The data&#x27;s encoding. Can be &#x60;&#x27;utf8&#x27;&#x60;, &#x60;&#x27;ascii&#x27;&#x60; or &#x60;&#x27;binary&#x27;&#x60;
	@param {String} [encoding=&#x27;hex&#x27;] The desired output encoding for the hash. Can be &#x60;&#x27;hex&#x27;&#x60;, &#x60;&#x27;binary&#x27;&#x60; or &#x60;&#x27;base64&#x27;&#x60;
	@returns {Object} The calculated hash value. The type of the return value depends on the given &#x60;encoding&#x60;
	 *&#x2F;
	function sha256Hash(data, dataEncoding, outputEncoding) {
		var hash = crypto.createHash(&#x27;sha256&#x27;);
		hash.update(data, dataEncoding || &#x27;binary&#x27;);
		return hash.digest(outputEncoding || &#x27;hex&#x27;);
	}

	&#x2F;**
	Signs a given request. Follows the [AWS signature v4](http:&#x2F;&#x2F;docs.amazonwebservices.com&#x2F;general&#x2F;latest&#x2F;gr&#x2F;signature-version-4.html)
	specs to add the &#x60;Authorization&#x60; header in &#x60;httpOpts&#x60;

	@method signRequest
	@private
	@param {Object} httpOpts The http options object that will be used when calling the &#x60;https.request()&#x60; method
	@param {Buffer} body The &#x60;Buffer&#x60; instance of the request body
	 *&#x2F;
	function signRequest(httpOpts, body) {
		if (securityToken) httpOpts.headers[&#x27;x-amz-security-token&#x27;] = securityToken;

		var headers = _.extend({host: httpOpts.host}, httpOpts.headers),
			headerNames = _.sortBy(_.keys(headers), function(name) { return name.toLowerCase(); }),
			isoDate = headers[&#x27;x-amz-date&#x27;],
			dateStr = isoDate.substr(0, 8),
			credentialScope = dateStr + &#x27;&#x2F;&#x27; + region + &#x27;&#x2F;&#x27; + SERVICE_NAME.toLowerCase() + &#x27;&#x2F;aws4_request&#x27;;

		var canonicalRequest = httpOpts.method + &#x27;\n&#x27; +
			encodeURI(httpOpts.path) + &#x27;\n&#x27; +
			&#x27;\n&#x27; + &#x2F;&#x2F; Query String
			_.map(headerNames, function(name) { return name.toLowerCase() + &#x27;:&#x27; + (&#x27;&#x27; + headers[name]).trim() + &#x27;\n&#x27;; }).join(&#x27;&#x27;) + &#x27;\n&#x27; +
			_.map(headerNames, function(name) { return name.toLowerCase(); }).join(&#x27;;&#x27;) + &#x27;\n&#x27; +
			sha256Hash(body);

		var strToSign = &#x27;AWS4-HMAC-SHA256\n&#x27; +
			isoDate + &#x27;\n&#x27; +
			credentialScope + &#x27;\n&#x27; +
			sha256Hash(canonicalRequest, &#x27;utf8&#x27;);

		var derivedKey = hmac(hmac(hmac(hmac(&#x27;AWS4&#x27; + secretKey, dateStr), region), SERVICE_NAME.toLowerCase()), &#x27;aws4_request&#x27;),
			signature = hmac(derivedKey, strToSign, &#x27;hex&#x27;);

		httpOpts.headers.Authorization = &#x27;AWS4-HMAC-SHA256 Credential=&#x27; + accessKey + &#x27;&#x2F;&#x27; + credentialScope +
			&#x27;,SignedHeaders=&#x27; + _.map(headerNames, function(name) { return name.toLowerCase(); }).join(&#x27;;&#x27;) +
			&#x27;,Signature=&#x27; + signature;
	};

	&#x2F;**
	Generates an ISO8601 basic date string (&#x60;YYYYMMDD&#x27;T&#x27;HHMMSS&#x27;Z&#x27;&#x60;) for the given date instance

	@method basicISODate
	@private
	@param {Date} [date] A date instance. If no date is given, a &#x60;new Date()&#x60; is used
	@return {String} An ISO8601 basic date string
	 *&#x2F;
	function basicISODate(date) {
		&#x2F;&#x2F; Can be done with &#x60;str.replace(&#x2F;(-|:|\.\d{3}Z$)&#x2F;g, &#x27;&#x27;)&#x60;, but &#x60;substr()&#x60; performs better: http:&#x2F;&#x2F;jsperf.com&#x2F;iso8601-date-basic-format
		var str = (date || new Date()).toISOString();
		return str.substr(0, 4) + str.substr(5, 2) + str.substr(8, 5) + str.substr(14, 2) + str.substr(17, 2) + &#x27;Z&#x27;;
	}

	&#x2F;**
	This is the method that send the actual HTTP requests, caches the response, and executes the callback after the response has been received.

	@method httpRequest
	@private
	@param {Object} options The [HTTP options](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;http.html#http_http_request_options_callback) to use when sending the request.
	@param {Buffer|String} body The request&#x27;s body. Must be a [Buffer](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;buffer.html) or a String.
	Set it to &#x60;null&#x60;, &#x60;undefined&#x60;, &#x60;false&#x60;, or &#x60;&#x27;&#x27;&#x60; to send a request with no body (a &#x60;GET&#x60; request for instance).
	@param {Function} [callback] Callback function to call after the response has been received.
	@param {Boolean} [useHttps=false] Set this to true to use HTTPS.
	*&#x2F;
	function httpRequest(options, body, callback, useHttps) {
		&#x2F;&#x2F; The &#x60;processResponse&#x60; callback should only be called once. The [http docs](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;http.html#http_event_close_1)
		&#x2F;&#x2F; say that a &#x27;close&#x27; event can be fired after the &#x27;end&#x27; event has been fired. To ensure that the &#x60;processResponse&#x60; callback
		&#x2F;&#x2F; is called only once it is wrapped by &#x60;_.once()&#x60;
		var processResponse = _.once(function(error, responseBody, httpResponse) {
			if (!error &amp;&amp; httpResponse &amp;&amp; httpResponse.statusCode !== 200) error = httpResponse.statusCode;
			if (_.isFunction(callback)) callback(error, responseBody, httpResponse);
		});

		var request = (useHttps === true ? https : http).request(options, function(httpResponse) {
			var responseBody = &#x27;&#x27;;
			httpResponse.on(&#x27;data&#x27;, function(data) {
				responseBody += data.toString(); &#x2F;&#x2F; &#x27;data&#x27; can be a String or a Buffer object
			}).on(&#x27;close&#x27;, function(error) {
				processResponse(error, responseBody, httpResponse);
			}).on(&#x27;end&#x27;, function() {
				processResponse(undefined, responseBody, httpResponse);
			});
		}).on(&#x27;error&#x27;, processResponse);

		if (!_.isEmpty(body)) request.write(body);
		request.end();
	}

	&#x2F;**
	Underlying method that builds the request before sending it and relays the response to the callback.

	@method sendRequest
	@private
	@param {String} operationName Name of the DynamoDB operation to request.
	@param {Object|String} [body=&#x27;{}&#x27;] Body of the request.
	@param {Function} [callback] Callback function to call after receiving the response.
	@param {Object} [context=httpResponseObject] Context in which the callback should be executed.
	Defaults to the underlying HTTP response object.
	*&#x2F;
	function sendRequest(operationName, body, callback, context) {
		if (_.isFunction(body)) {
			context = callback;
			callback = body;
			body = undefined;
		}
		body || (body = {});
		body = new Buffer(_.isString(body) ? body : JSON.stringify(body));

		var httpOpts = {
			host: SERVICE_NAME.toLowerCase() + &#x27;.&#x27; + region + &#x27;.amazonaws.com&#x27;,
			port: 443,
			path: &#x27;&#x2F;&#x27;,
			method: &#x27;POST&#x27;,
			headers: {
				&#x27;x-amz-date&#x27;: basicISODate(),
				&#x27;x-amz-target&#x27;: SERVICE_NAME + &#x27;_&#x27; + API_VERSION + &#x27;.&#x27; + operationName,
				&#x27;Content-Type&#x27;: &#x27;application&#x2F;x-amz-json-1.0&#x27;
			}
		};
		signRequest(httpOpts, body);

		httpRequest(httpOpts, body, function(error, responseBody, httpResponse) {
			var json;
			try {
				json = JSON.parse(responseBody);
			} catch (parseError) {
				if (!error) error = parseError;
			}

			if (_.isFunction(callback)) callback.call(context || httpResponse, error, json || responseBody);
		}, true);
	}

	&#x2F;**
	Gets the EC2 IAM role name from the metadata service.

	@method getEC2IAMRole
	@private
	@param {Function} callback Callback function that receives the role returned by the metadata service.
	*&#x2F;
	function getEC2IAMRole(callback) {
		httpRequest({host: EC2_METADATA_HOST, path: SECURITY_CREDENTIALS_RESOURCE}, null, function(error, role, httpResponse) {
			callback(error, _.isString(role) ? role.trim() : role, httpResponse);
		});
	}

	&#x2F;**
	Gets the security credentials from the metadata service.

	@method getEC2IAMSecurityCredentials
	@private
	@param {String} role IAM role name.
	@param {Function} callback Callback function that receives the parsed credentials object returned by the metadata service.
	*&#x2F;
	function getEC2IAMSecurityCredentials(role, callback) {
		httpRequest({host: EC2_METADATA_HOST, path: SECURITY_CREDENTIALS_RESOURCE + role}, null, function(error, jsonStr, httpResponse) {
			var credentials;
			try {
				credentials = JSON.parse(jsonStr);
			} catch (parseError) {
				if (!error) error = parseError;
			}

			callback(error, credentials, httpResponse);
		});
	}

	&#x2F;**
	Helper function that returns &#x60;true&#x60; if getting the security credentials from the metadata service is needed or &#x60;false&#x60; otherwise.

	@method needsToLoadEC2IAMRoleCredentials
	@private
	*&#x2F;
	function needsToLoadEC2IAMRoleCredentials() {
		if (!accessKey || !secretKey) return true;
		if (credentialsExpiration === null) return false;
		return (credentialsExpiration.getTime() - Date.now()) &lt; CREDENTIALS_EXPIRATION_THRESHOLD;
	}

	&#x2F;**
	Sends a request to Amazon DynamoDB

	@method request
	@chainable
	@param {String} operationName Name of the DynamoDB operation to request. Consult
	[DynamoDB documentation](http:&#x2F;&#x2F;docs.amazonwebservices.com&#x2F;amazondynamodb&#x2F;latest&#x2F;developerguide&#x2F;operationlist.html &#x27;DynamoDB Operations&#x27;)
	for a list of available operations
	@param {Object|String} [body=&#x27;{}&#x27;] Body of the request to send. If it&#x27;s not a string, it is converted into a string using &#x60;JSON.stringify()&#x60;.
	Consult [DynamoDB documentation](http:&#x2F;&#x2F;docs.amazonwebservices.com&#x2F;amazondynamodb&#x2F;latest&#x2F;developerguide&#x2F;operationlist.html &#x27;DynamoDB Operations&#x27;)
	for details about the body for each type of operation
	@param {Function} [callback] Callback function to execute after the response has been received or when an error was triggered during the request.
	The callback function should take the following arguments:
		@param {Object} callback.error This can be:

	1. The error object passed by the underlying http request if the &#x27;error&#x27; event was triggered
	2. The response&#x27;s status code, if it&#x27;s not &#x60;200&#x60;
	3. Exception object thrown by &#x60;JSON.parse()&#x60;
	4. Undefined if there was no error

		@param {Object|String} callback.json The parsed JSON response or a string if the response is not a valid JSON string
	@param {Object} [context] The &#x60;context&#x60; in which the callback should be executed, meaning that whenever the callback function is called,
	the value of &#x60;this&#x60;, inside the callback, will be &#x60;context&#x60;. If no &#x60;context&#x60; is given, the value of &#x60;this&#x60; would be the underlying request&#x27;s
	[http.ClientResponse](http:&#x2F;&#x2F;nodejs.org&#x2F;api&#x2F;http.html#http_http_clientresponse) object, which contains data like &#x60;statusCode&#x60; and &#x60;headers&#x60;
	 *&#x2F;
	this.request = function(operationName, body, callback, context) {
		if (needsToLoadEC2IAMRoleCredentials()) {
			var _this = this,
				_arguments = arguments;

			getEC2IAMRole(function(error, role, httpResponse) {
				getEC2IAMSecurityCredentials(role, function(error, credentials, httpResponse) {
					if (!credentials || !credentials.AccessKeyId || !credentials.SecretAccessKey) {
						throw &#x27;AWS credentials not set. &#x27; +
							&#x27;Please set AWS credentials manually, using environment variables, or using EC2 IAM roles. &#x27; +
							&#x27;See documentation for details.&#x27;;
					}

					accessKey = credentials.AccessKeyId;
					secretKey = credentials.SecretAccessKey;
					securityToken = credentials.Token;
					credentialsExpiration = new Date(credentials.Expiration);

					sendRequest.apply(_this, _arguments);
				});
			});
		} else {
			sendRequest.apply(this, arguments);
		}
	
		return this;
	};
}

module.exports = DynDB;
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
